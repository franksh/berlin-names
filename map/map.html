<!DOCTYPE html>
<head>
  <title>Berlin Names</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>
</head>

<body>

  <h2>Berlin Names</h2>

  <div class="flex-container">
    <div id="left-column">
      <svg width="600" height="400" margin="10px"></svg>
    </div>

    <div id="right-column">
      <h2 id="bezirk-title">Title</h2>
    </div>
  </div>

  <script>

  var svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height");

  var map = d3.map();

  var nameBox = d3.select("#right-column")
                  .append("table")
                  .attr("id", "nameBox");

  nameBox.append("tr")
          .append("td")
          .text("Beliebteste Vornamen")
          .attr("class", "tableheader");

  var percentScale = d3.scale.linear()
                        .domain([50,200])
                        .interpolate(d3.interpolateHcl)
                        .range([d3.rgb("#bfbfbf"), d3.rgb("#1aff66")]);

  //var path = d3.geoPath();

  /*
  var x = d3.scaleLinear()
      .domain([1, 10])
      .rangeRound([600, 860]);

  var color = d3.scaleThreshold()
      .domain(d3.range(2, 10))
      .range(d3.schemeBlues[9]);
  */
  /*
  var g = svg.append("g")
      .attr("class", "key")
      .attr("transform", "translate(0,40)");

  g.selectAll("rect")
    .data(color.range().map(function(d) {
        d = color.invertExtent(d);
        if (d[0] == null) d[0] = x.domain()[0];
        if (d[1] == null) d[1] = x.domain()[1];
        return d;
      }))
    .enter().append("rect")
      .attr("height", 8)
      .attr("x", function(d) { return x(d[0]); })
      .attr("width", function(d) { return x(d[1]) - x(d[0]); })
      .attr("fill", function(d) { return color(d[0]); });

  g.append("text")
      .attr("class", "caption")
      .attr("x", x.range()[0])
      .attr("y", -6)
      .attr("fill", "#000")
      .attr("text-anchor", "start")
      .attr("font-weight", "bold")
      .text("Unemployment rate");

  g.call(d3.axisBottom(x)
      .tickSize(13)
      .tickFormat(function(x, i) { return i ? x : x + "%"; })
      .tickValues(color.domain()))
    .select(".domain")
      .remove();
  */
  var namedata = [];

  d3.csv("../data/processed/beliebte_namen_2016.csv", function(data) {
    // Parse data
    data.forEach(function(d) {
      d.anzahl = +d.anzahl; //convert to number
      d.freq_dev = +d.freq_dev;
    });
    namedata = data;

  });

  /*
  var datas = [1,3,4,5, 6];
  nameBox.selectAll(".tablerow")
    .data(datas).enter()
    .append("tr")
    .attr("class", "tablerow")
    .append("td")
    .text(function(d) {return d;});
  */

  d3.queue()
      .defer(d3.json, "bezirke.topojson")
      //.defer(d3.tsv, "unemployment.tsv", function(d) { unemployment.set(d.id, +d.rate); })
      .await(loadMap);

  function loadMap(error, bezirke) {
    if (error) throw error;

    var projection = d3.geo.mercator()
        .center([13.7,52.5])
      //.rotate([0, 0])
        .scale(40000);
      //.parallels([50,10])
    //  .translate([width/1000, height/0.5]);

    var path = d3.geo.path()
          .projection(projection);

    var states = topojson.feature(bezirke, bezirke.objects.states);

    svg.selectAll(".states")
        .data(states.features)
        .enter().append("path")
        .attr("class", "states")
        .attr("d", path)
        .attr("fill", "#0099CC")
        .attr("highlighted", "false")
        .attr("name", function(d){return d.properties.id;})
        //.style("opacity", 0.5)
        .on("mouseover", mouseOver)
        .on("mouseout", mouseOut)
        .on("click", selectState);



    function mouseOver(d) {
      var state = d3.select(this);
      console.log(d.properties.id);
      highlightState(state);
    }

    function mouseOut(d) {
      var state = d3.select(this);
      unhighlightState(state);
    }

    function highlightState(state) {
      if (!state.classed("selected-state")) {
        state
          .transition().duration(200)
          .style("opacity", 0.8);
      }
    }

    function unhighlightState(state) {
      //console.log(d3.select(this));
      //var state = d3.select(this);
      //if (!state.classed("highlighted")) {
      state
        .transition().duration(200)
        // Style here is element property while in css is class property
        .style("opacity", null);
      //}
    }

    function selectState(d) {
      //console.log(d);
      //svg.selectAll(".states");
      d3.selectAll("#bezirk-title").text(d.properties.id);

      d3.selectAll(".states")
        .classed("selected-state", false);

      d3.select(this)
      //.transition().duration(300)
      .classed("selected-state", true);
      //.attr("highlighted", true);
      //.style("stroke-width", "3px")
      //.style("opacity", 1);

      console.log(d.properties.id);

      var selectedBezirk = d.properties.id;

      /*

      // Update existing entries
      nameBox.selectAll(".tablerow")
        .data(namedata.filter(function(d) {return d.bezirk==selectedBezirk;}))
        .text(function(d) {return d.vorname;});

      // Create new rows for all non-existing entries
      nameBox.selectAll(".tablerow")
        .data(namedata.filter(function(d) {return d.bezirk==selectedBezirk;}))
        .enter()
        .append("tr")
        .attr("class", "tablerow")
        .append("td")
        .text(function(d) {
          return d.vorname;
        })
        .append("td")
        .text(function(d) {return d.freq_dev;});
      */

      var columns = ['vorname', 'freq_dev', 'geschlecht'];

      var bezirkdata = namedata.filter(function(d) {return d.bezirk==selectedBezirk;});

      // Update existing rows
      var rows = nameBox.selectAll(".tablerow")
            .data(bezirkdata)
            .attr("class", "tablerow");

      rows.selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {value: row[column], name:column};
          });
        })
        .text(function(d) { return d.value; })
        .style("color", function(d){
          if (d.name=='freq_dev') {
            return percentScale(d.value);
          }
        })
        ;

      // Create new rows
      var rows = nameBox.selectAll(".tablerow")
            .data(bezirkdata)
            .enter()
            .append("tr")
            .attr("class", "tablerow");

      rows.selectAll("td")
        .data(function(row) {
          return columns.map(function(column) {
            return {value: row[column], name:column};
          });
        })
        .enter()
        .append("td")
        .text(function(d) { return d.value; })
        .attr("class", function(d) {return d.name;})
        .style("color", function(d){
          if (d.name=='freq_dev') {
            return percentScale(d.value);
          }
        })
        ;



      /*
      nameBox.selectAll("tablerow")
        .data(d.properties.id).enter()
        .append("tr")
        .attr("class", "tablerow")
        .append("td")
        .text(d.properties.id);
      */
      //d3.selectAll(".states")
      //.each(unhighlightState);
      d3.selectAll(".states")
        .classed("name", "Mitte")
        .style("color", function(d){console.log(d); return "white";})
    }


        /*
    svg.append("g")
        .attr("class", "states")
      .selectAll("path")
      .data(topojson.feature(bezirke, bezirke.objects.states).features)
      .enter().append("path")
        .attr("fill", 'blue') //function(d) { return color(d.rate = unemployment.get(d.id)); })
        .attr("d", path)
        */
      //.append("title")
      //  .text(function(d) { return d.rate + "%"; });

  /*
    svg.append("path")
        .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
        .attr("class", "states")
        .attr("d", path);
  */



  }



  </script>
</body>
